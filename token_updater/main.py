"""Token Updater 主入口 v3.0 - 轻量版"""
import asyncio
import uvicorn
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.interval import IntervalTrigger
from .api import app
from .browser import browser_manager
from .updater import token_syncer
from .database import profile_db
from .config import config
from .logger import logger
from .gcli2api_bridge import gcli2api_bridge


scheduler = AsyncIOScheduler()
SYNC_JOB_ID = "token_sync"
GEMINI_SYNC_JOB_ID = "gemini_sync"
GCLI2API_SYNC_JOB_ID = "gcli2api_sync"


async def scheduled_sync():
    """定时同步任务（Flow2API + Gemini 联合）"""
    logger.info("=== 定时同步任务触发 ===")

    if not config.connection_token:
        logger.warning("未配置 CONNECTION_TOKEN，跳过本次同步")
        return

    profiles = await profile_db.get_logged_in_profiles()
    if not profiles:
        logger.warning("没有已登录的 Profile，跳过本次同步")
        return

    await token_syncer.sync_all_profiles()


async def scheduled_gemini_sync():
    """Gemini 独立定时同步任务"""
    if not config.gemini_api_url:
        return

    logger.info("=== Gemini 定时同步任务触发 ===")

    profiles = await profile_db.get_logged_in_profiles()
    if not profiles:
        logger.warning("没有已登录的 Profile，跳过 Gemini 同步")
        return

    await token_syncer.sync_all_gemini()


async def scheduled_gcli2api_sync():
    """gcli2api 定时同步任务"""
    if not config.gcli2api_url:
        return

    logger.info("=== gcli2api 定时同步任务触发 ===")

    profiles = await profile_db.get_logged_in_profiles()
    if not profiles:
        logger.warning("没有已登录的 Profile，跳过 gcli2api 同步")
        return

    await gcli2api_bridge.sync_all_to_gcli2api()


async def startup():
    """启动时初始化"""
    logger.info("=" * 60)
    logger.info("Flow2API Token Updater v3.0 - 轻量版")
    logger.info("Cookie 导入模式")
    logger.info("=" * 60)

    await profile_db.init()
    logger.info("数据库初始化完成")

    scheduler.add_job(
        scheduled_sync,
        trigger=IntervalTrigger(minutes=config.refresh_interval),
        id=SYNC_JOB_ID,
        max_instances=1,
        coalesce=True,
        replace_existing=True
    )

    # Gemini 独立定时任务
    if config.gemini_api_url:
        scheduler.add_job(
            scheduled_gemini_sync,
            trigger=IntervalTrigger(minutes=config.gemini_refresh_interval),
            id=GEMINI_SYNC_JOB_ID,
            max_instances=1,
            coalesce=True,
            replace_existing=True,
        )
        logger.info(f"Gemini 定时任务已启动: 每 {config.gemini_refresh_interval} 分钟执行一次")

    # gcli2api 定时任务
    if config.gcli2api_url:
        scheduler.add_job(
            scheduled_gcli2api_sync,
            trigger=IntervalTrigger(minutes=config.gcli2api_refresh_interval),
            id=GCLI2API_SYNC_JOB_ID,
            max_instances=1,
            coalesce=True,
            replace_existing=True,
        )
        logger.info(f"gcli2api 定时任务已启动: 每 {config.gcli2api_refresh_interval} 分钟执行一次")

    scheduler.start()

    app.state.scheduler = scheduler
    app.state.sync_job_id = SYNC_JOB_ID
    app.state.gemini_sync_job_id = GEMINI_SYNC_JOB_ID
    app.state.gcli2api_sync_job_id = GCLI2API_SYNC_JOB_ID

    logger.info(f"定时任务已启动: 每 {config.refresh_interval} 分钟执行一次")
    logger.info(f"Flow2API URL: {config.flow2api_url}")
    logger.info(f"API 端口: {config.api_port}")
    logger.info("")
    logger.info("管理界面: http://localhost:8002")
    logger.info("")


async def shutdown():
    """关闭时清理"""
    logger.info("正在关闭...")
    if scheduler.running:
        scheduler.shutdown()
    await browser_manager.stop()


@app.on_event("startup")
async def on_startup():
    await startup()


@app.on_event("shutdown")
async def on_shutdown():
    await shutdown()


def main():
    """主函数"""
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=config.api_port,
        log_level="info"
    )


if __name__ == "__main__":
    main()
